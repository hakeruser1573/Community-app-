<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>All In One - Final Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505;
            --surface: #0f0f11;
            --primary: #7c3aed;
            --primary-grad: linear-gradient(135deg, #7c3aed, #6d28d9);
            --accent: #06b6d4;
            --text: #ffffff;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --vip: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 60%);
            color: var(--text);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden;
        }

        /* --- UTILS --- */
        .glass {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
        }
        .hidden { display: none !important; }
        .btn { border: none; cursor: pointer; transition: 0.2s; border-radius: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.96); }

        /* --- LOADING --- */
        #loader-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        /* --- LOGIN --- */
        #login-screen { position: fixed; inset: 0; z-index: 2000; background: var(--bg); display: flex; align-items: center; justify-content: center; }
        .login-card { width: 85%; max-width: 380px; padding: 40px 30px; background: #09090b; border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; box-shadow: 0 0 40px rgba(124, 58, 237, 0.1); text-align: center; }
        .login-title { font-size: 1.8rem; font-weight: 800; line-height: 1.2; margin-bottom: 5px; background: linear-gradient(to right, #fff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .founder-badge { color: var(--accent); font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 30px; display: block; opacity: 0.9; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; background: #18181b; border: 1px solid #333; color: white; border-radius: 12px; outline: none; font-size: 1rem; }
        .btn-login { width: 100%; padding: 15px; background: var(--primary-grad); color: white; font-size: 1rem; margin-top: 10px; }

        /* --- MAIN APP --- */
        #main-app { width: 100%; max-width: 480px; height: 100vh; overflow-y: auto; padding: 20px; display: none; padding-bottom: 100px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover; }
        .logout-btn { background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 8px 16px; border: 1px solid rgba(239, 68, 68, 0.3); font-size: 0.8rem; }

        /* GRID (TOP) */
        .grid-title { font-size: 0.8rem; font-weight: 700; color: #666; margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 30px; }
        .app-card { aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 20px; cursor: pointer; position: relative; transition: 0.2s; }
        .app-card:active { transform: scale(0.95); background: rgba(255,255,255,0.08); }
        .app-card i { font-size: 1.6rem; margin-bottom: 8px; color: var(--text-muted); }
        .app-card span { font-size: 0.7rem; font-weight: 500; text-align: center; }
        .badge { position: absolute; top: 8px; right: 8px; background: var(--danger); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 0.6rem; display: flex; align-items: center; justify-content: center; }
        /* Colors */
        .app-card:nth-child(1) i { color: #f472b6; } .app-card:nth-child(2) i { color: #22d3ee; } .app-card:nth-child(3) i { color: #a78bfa; } .app-card:nth-child(8) i { color: #fbbf24; }

        /* ADMIN ZONE */
        .admin-zone { background: rgba(124, 58, 237, 0.05); border: 1px dashed var(--primary); padding: 20px; border-radius: 20px; margin-bottom: 30px; display: none; }
        .admin-head { color: var(--primary); font-size: 0.85rem; font-weight: 800; letter-spacing: 1px; margin-bottom: 15px; text-transform: uppercase; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .admin-btn { padding: 15px; background: #18181b; border: 1px solid #333; border-radius: 16px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 0.9rem; }

        /* CALENDAR (BOTTOM - FIXED DOTS) */
        .cal-box { padding: 20px; background: rgba(20,20,22,0.6); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .cal-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 700; color: var(--accent); }
        .week-row { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 10px; font-size: 0.75rem; color: #666; font-weight: bold; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day { height: 35px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.8rem; position: relative; background: rgba(255,255,255,0.03); }
        .day.today { border: 1px solid var(--primary); color: white; font-weight: 800; background: rgba(139, 92, 246, 0.15); }
        
        /* THE DOTS */
        .dots-row { display: flex; gap: 3px; position: absolute; bottom: 3px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }
        .dot-p { background: var(--success); box-shadow: 0 0 4px var(--success); } 
        .dot-a { background: var(--danger); box-shadow: 0 0 4px var(--danger); } 
        .dot-hd { background: var(--warning); }
        .dot-e { background: var(--accent); }

        /* --- FEATURE MODAL --- */
        #feature-modal { position: fixed; inset: 0; z-index: 3000; background: var(--bg); display: none; flex-direction: column; }
        .modal-nav { padding: 15px 20px; background: rgba(15, 15, 20, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #27272a; height: 60px; }
        .modal-content { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); scroll-behavior: smooth; }

        /* --- MEDIA --- */
        #media-viewer { position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; }
        #media-img { max-width: 90%; max-height: 80%; border-radius: 12px; }
        .close-media { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; }

        /* --- CHAT (VIP) --- */
        .chat-wrap { display: flex; flex-direction: column; height: 100%; }
        .chat-feed { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
        .msg-row { display: flex; width: 100%; } .msg-row.mine { justify-content: flex-end; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; position: relative; background: #27272a; }
        .msg.mine { background: var(--primary-grad); color: white; }
        .msg-img { max-width: 100%; border-radius: 10px; margin-bottom: 5px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .chat-bar { position: absolute; bottom: 20px; left: 10px; right: 10px; padding: 8px; background: rgba(30, 30, 30, 0.95); display: flex; gap: 10px; align-items: center; border-radius: 30px; border: 1px solid #444; }
        .chat-in { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 1rem; }
        .vip-tag { color: var(--vip); font-size: 0.65rem; background: rgba(255, 215, 0, 0.1); border: 1px solid var(--vip); padding: 1px 4px; border-radius: 4px; margin-left: 5px; font-weight: bold; }

        /* --- TIME TABLE PRO --- */
        .tt-wrapper { overflow-x: auto; background: #121212; border-radius: 16px; border: 1px solid #333; padding-bottom: 10px; }
        .tt-grid { display: grid; grid-template-columns: 80px repeat(6, 140px); }
        .tt-cell { padding: 15px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; min-height: 60px; text-align: center; border-right: 1px solid #222; border-bottom: 1px solid #222; color: #ccc; }
        .tt-head { background: #1e1e1e; font-weight: 700; color: var(--accent); border-bottom: 2px solid #333; position: sticky; top: 0; }
        .tt-time { background: #18181b; font-weight: 600; color: var(--text-muted); border-right: 2px solid #333; position: sticky; left: 0; }
        .tt-input { width: 100%; background: transparent; border: none; color: white; text-align: center; outline: none; font-family: inherit; }

        /* LISTS */
        .list-card { background: #18181b; border: 1px solid #333; padding: 15px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .del-icon { color: var(--danger); cursor: pointer; padding: 5px; }

        /* ADMIN ATTENDANCE */
        .attn-date-bar { background: #222; padding: 10px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #333; }
        .st-card { background: #18181b; border: 1px solid #333; padding: 15px; border-radius: 16px; margin-bottom: 10px; }
        .st-acts { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .act-btn { padding: 10px 0; background: #222; border: 1px solid #333; color: #666; border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.8rem; font-weight: 700; transition: 0.2s; }
        .act-btn.active-P { background: var(--success); color: black; }
        .act-btn.active-A { background: var(--danger); color: white; }
        .act-btn.active-HD { background: var(--warning); color: black; }
        .act-btn.active-H { background: var(--accent); color: black; }

        /* MODAL INPUT */
        #input-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #18181b; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; border: 1px solid #333; }
        .modal-field { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; outline: none; }
    </style>
</head>
<body>

    <div id="loader-overlay"><div class="spinner"></div><p style="margin-top:15px;color:white">Syncing...</p></div>
    
    <div id="media-viewer">
        <span class="close-media" onclick="document.getElementById('media-viewer').style.display='none'">&times;</span>
        <img id="media-img">
    </div>

    <div id="input-modal"><div class="modal-box"><h3 id="im-title" style="margin-bottom:15px">Edit</h3><div id="im-fields"></div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px"><button onclick="document.getElementById('input-modal').style.display='none'" class="btn" style="background:#333;color:white;padding:8px 16px">Cancel</button><button id="im-save" class="btn" style="background:var(--primary);color:white;padding:8px 20px">Save</button></div></div></div>

    <div id="login-screen">
        <div class="login-card">
            <h1 class="login-title">All In One Community</h1>
            <span class="founder-badge">Founder: CDT Master Kartik Garade</span>
            <input id="u-in" class="login-input" placeholder="Username" autocomplete="off">
            <input id="p-in" type="password" class="login-input" placeholder="Password">
            <button class="btn btn-login" onclick="app.login()">Get Started</button>
            <p id="err-msg" style="color:var(--danger); margin-top:15px; font-size:0.9rem; display:none;"></p>
        </div>
    </div>

    <div id="main-app">
        <header>
            <div class="user-info">
                <img id="u-img" class="avatar" src="">
                <div><h3 id="u-name" style="line-height:1">User</h3><span id="u-role" style="font-size:0.8rem;color:#888">Student</span></div>
            </div>
            <button onclick="location.reload()" class="logout-btn">Logout</button>
        </header>

        <div class="grid-title">QUICK ACCESS</div>
        <div class="grid">
            <div class="app-card" onclick="app.open('notes')"><i class="fas fa-book" style="color:#f472b6"></i><span>Notes</span></div>
            <div class="app-card" onclick="app.open('ann')"><i class="fas fa-bullhorn" style="color:#22d3ee"></i><span>Announce</span><div id="badge-ann" class="badge hidden">0</div></div>
            <div class="app-card" onclick="app.open('chat')"><i class="fas fa-comments" style="color:#a78bfa"></i><span>Chat</span><div id="badge-chat" class="badge hidden">0</div></div>
            <div class="app-card" onclick="app.open('email')"><i class="fas fa-envelope"></i><span>Email</span></div>
            <div class="app-card" onclick="app.open('papers')"><i class="fas fa-file-alt"></i><span>Papers</span></div>
            <div class="app-card" onclick="app.open('syllabus')"><i class="fas fa-chart-pie"></i><span>Syllabus</span></div>
            <div class="app-card" onclick="app.open('timetable')"><i class="fas fa-calendar-alt"></i><span>Table</span></div>
            <div class="app-card" onclick="app.open('news')"><i class="fas fa-globe"></i><span>News</span></div>
            <div class="app-card" onclick="app.open('teach')"><i class="fas fa-chalkboard-user"></i><span>Teachers</span></div>
        </div>

        <div id="admin-zone" class="admin-zone">
            <div class="admin-head"><i class="fas fa-shield-alt"></i> Admin Panel</div>
            <div class="admin-grid">
                <div class="admin-btn" onclick="app.modal('Add Event',[{id:'t',label:'Title'},{id:'d',label:'Date'}],(v)=>app.addEvent(v[0],v[1]))"><i class="fas fa-calendar-plus"></i><span>Event</span></div>
                <div class="admin-btn" onclick="app.modal('Update Exam',[{id:'n',label:'Name'},{id:'d',label:'Date'}],(v)=>app.updateExam(v[0],v[1]))"><i class="fas fa-edit"></i><span>Set Exam</span></div>
                <div class="admin-btn" onclick="app.openAttn()"><i class="fas fa-user-check" style="color:var(--success)"></i><span>Attendance</span></div>
                <div class="admin-btn" onclick="app.openBan()"><i class="fas fa-users-cog" style="color:var(--warning)"></i><span>Users / VIP</span></div>
            </div>
        </div>

        <div class="grid-title">SCHEDULE</div>
        <div class="cal-box">
            <div class="cal-header"><span id="cal-month">Month</span> <span id="clock" style="font-weight:400;color:#888">00:00</span></div>
            <div class="week-row"><div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div></div>
            <div id="cal-grid" class="cal-grid"></div>
            <div style="margin-top:15px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);font-size:0.8rem;color:#666;display:flex;justify-content:space-between">
                <span>Next: <b id="next-ev" style="color:var(--text)">None</b></span>
            </div>
        </div>

        <div class="glass" style="padding:15px; display:flex; gap:15px; align-items:center; margin-bottom:20px; border:1px solid rgba(239,68,68,0.3); background:rgba(239,68,68,0.05)">
            <span style="background:var(--danger); color:white; font-weight:bold; font-size:0.7rem; padding:4px 8px; border-radius:4px;">EXAM</span>
            <span id="next-exam-text" style="font-size:0.9rem;">Loading...</span>
            <i class="fas fa-trash del-icon" id="exam-del-btn" style="margin-left:auto; display:none" onclick="app.delExam()"></i>
        </div>
    </div>

    <div id="feature-modal" style="position:fixed;inset:0;background:#000;z-index:3000;display:none;flex-direction:column">
        <div class="modal-nav" style="padding:15px 20px;background:#111;display:flex;justify-content:space-between;border-bottom:1px solid #333"><button onclick="document.getElementById('feature-modal').style.display='none'" style="background:none;border:none;color:white;font-size:1.2rem"><i class="fas fa-arrow-left"></i></button><b id="f-title">Title</b><div></div></div>
        <div id="f-body" style="flex:1;overflow-y:auto;padding:20px;scroll-behavior:smooth"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const appConfig = { apiKey: "AIzaSyCtjsy_NUH3vNHbiXlGP4nUmusefzIuJyI", authDomain: "all-in-one-community.firebaseapp.com", projectId: "all-in-one-community", storageBucket: "all-in-one-community.firebasestorage.app", messagingSenderId: "461209960805", appId: "1:461209960805:web:6f73660513cf6d3c40e18c" };
        const db = getFirestore(initializeApp(appConfig));

        const USERS = ["Kartik","Rohan","Ranveer","Rishikesh","Malhar","Kunal","Raj","Saksham","Shravan","Soham Shivkar","Soham Ozkar","Soham Gade","Amrit","Atharva","Vedant","Mithilesh","Parth"];
        const SUBS = ["Hindi","Sanskrit","Marathi","English","Maths","Physics","Chemistry","Biology","History","Civics","Geography","Economics","IT"];
        
        let state = { user:null, admin:false, attn:{}, chats:[], anns:[], events:[], banned:[], vips:[], teachers:[], news:[], tt:{}, file:null, selectedDate: new Date().toISOString().split('T')[0] };

        window.app = {
            login: () => {
                const u = document.getElementById('u-in').value.trim();
                const p = document.getElementById('p-in').value.trim();
                document.getElementById('loader-overlay').style.display='flex';

                onSnapshot(doc(db, "settings", "banned"), (snap) => {
                    const d = snap.data() || {};
                    state.banned = d.list || [];
                    state.vips = d.vips || [];
                    setTimeout(() => {
                        let success = false;
                        if(u==='admin' && p==='admin@157390'){ success=true; state.admin=true; state.user='Admin'; }
                        else {
                            const found = USERS.find(user => user.toLowerCase() === u.toLowerCase());
                            if(found && p === '1234') {
                                if(state.banned.includes(found)) { alert("BANNED"); location.reload(); return; }
                                success=true; state.user=found;
                            }
                        }

                        if(success) {
                            document.getElementById('login-screen').style.display='none';
                            document.getElementById('main-app').style.display='block';
                            document.getElementById('u-name').innerText = state.user;
                            document.getElementById('u-img').src = `https://ui-avatars.com/api/?name=${state.user}&background=random`;
                            if(state.admin) {
                                document.getElementById('admin-zone').style.display='block';
                                document.getElementById('exam-del-btn').style.display='block';
                            }
                            window.app.listen();
                            window.app.renderCal();
                            document.getElementById('loader-overlay').style.display='none';
                        } else {
                            document.getElementById('loader-overlay').style.display='none';
                            document.getElementById('err-msg').innerText="Invalid Credentials";
                            document.getElementById('err-msg').style.display='block';
                        }
                    }, 1000);
                });
            },

            listen: () => {
                onSnapshot(query(collection(db,"chats"), orderBy("time","asc")), (s)=>{
                    state.chats=[]; s.forEach(d=>state.chats.push({id:d.id,...d.data()}));
                    if(document.getElementById('chat-feed')) window.app.renderChat();
                    const last = parseInt(localStorage.getItem('lc')||0);
                    if(state.chats.length>last) document.getElementById('badge-chat').classList.remove('hidden');
                });
                onSnapshot(collection(db,"teachers"), (s)=>{
                    state.teachers=[]; s.forEach(d=>state.teachers.push({id:d.id,...d.data()}));
                    if(document.getElementById('teach-list')) window.app.renderTeachers();
                });
                onSnapshot(query(collection(db,"news"), orderBy("time","desc")), (s)=>{
                    state.news=[]; s.forEach(d=>state.news.push({id:d.id,...d.data()}));
                    if(document.getElementById('news-list')) window.app.renderNews();
                });
                onSnapshot(collection(db,"announcements"), (s)=>{
                    state.anns=[]; s.forEach(d=>state.anns.push({id:d.id,...d.data()}));
                    const last = parseInt(localStorage.getItem('la')||0);
                    if(state.anns.length>last) document.getElementById('badge-ann').classList.remove('hidden');
                    if(document.getElementById('ann-feed')) window.app.renderAnn();
                });
                onSnapshot(collection(db,"events"), (s)=>{
                    state.events=[]; s.forEach(d=>state.events.push({id:d.id,...d.data()}));
                    window.app.renderCal();
                });
                // ATTENDANCE LOGIC
                onSnapshot(collection(db,"attendance_log"), (s)=>{
                    state.attn = {};
                    s.forEach(d=>{ state.attn[d.id] = d.data(); });
                    // Refresh if Admin Panel open
                    if(document.getElementById('attn-list')) window.app.renderAdminAttn();
                    // Refresh Main Calendar
                    window.app.renderCal();
                });
                onSnapshot(doc(db, "settings", "exam"), (snap) => {
                    if(snap.exists()) document.getElementById('next-exam-text').innerText = `${snap.data().name} (${snap.data().date})`;
                    else document.getElementById('next-exam-text').innerText = "No Exam Scheduled";
                });
                onSnapshot(doc(db,"settings","timetable"), (s)=>{
                    state.tt = s.exists() ? s.data().data || {} : {};
                    if(document.getElementById('tt-grid')) window.app.renderTimeTable();
                });
            },

            renderCal: () => {
                const d=new Date(); document.getElementById('cal-month').innerText=d.toLocaleString('default',{month:'long'});
                const g=document.getElementById('cal-grid'); g.innerHTML='';
                
                const year = d.getFullYear();
                const month = d.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayIndex = new Date(year, month, 1).getDay();

                const nextEv = state.events.find(e => new Date(e.date) >= new Date());
                document.getElementById('next-ev').innerText = nextEv ? `${nextEv.title} (${new Date(nextEv.date).getDate()})` : "None";

                for(let i=0; i<firstDayIndex; i++) g.innerHTML += `<div></div>`;

                for(let i=1;i<=daysInMonth;i++){
                    const k=`${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    let dots = '';
                    
                    // 1. Attendance Dots
                    if(state.attn[k] && state.attn[k][state.user]) {
                        const s = state.attn[k][state.user];
                        if(s==='P') dots+=`<div class="dot dot-p"></div>`;
                        else if(s==='A') dots+=`<div class="dot dot-a"></div>`;
                        else if(s==='HD') dots+=`<div class="dot dot-e"></div>`;
                    }
                    // 2. Event Dots
                    if(state.events.find(e=>e.date===k)) dots+=`<div class="dot dot-e"></div>`;
                    
                    const isToday = i === d.getDate() ? 'today' : '';
                    g.innerHTML += `<div class="day ${isToday}">${i}<div class="dots-row">${dots}</div></div>`;
                }
            },

            open: (t) => {
                const m=document.getElementById('feature-modal'); m.style.display='flex';
                document.getElementById('f-title').innerText=t.toUpperCase();
                const b=document.getElementById('f-body'); b.innerHTML='';
                
                if(t==='notes'||t==='syllabus'||t==='papers'){
                    SUBS.forEach(s=>b.innerHTML+=`<div class="list-card" onclick="alert('Opening ${s}...')"><b>${s}</b><i class="fas fa-chevron-right" style="color:#666"></i></div>`);
                } else if(t==='chat'){
                    localStorage.setItem('lc', state.chats.length); document.getElementById('badge-chat').classList.add('hidden');
                    b.innerHTML=`<div class="chat-wrap"><div id="chat-feed" class="chat-feed"></div><div class="chat-bar"><label><i class="fas fa-paperclip" style="color:#aaa;margin-right:10px;font-size:1.2rem"></i><input type="file" hidden onchange="app.sendFile(event)"></label><input id="c-in" class="chat-in" placeholder="Message..."><i class="fas fa-paper-plane" style="color:var(--accent)" onclick="app.send()"></i></div></div>`;
                    window.app.renderChat();
                } else if(t==='teach'){
                    if(state.admin) b.innerHTML=`<button class="btn" style="width:100%;background:var(--primary);color:white;padding:10px;margin-bottom:15px" onclick="app.modal('Add Teacher',[{id:'s',label:'Subject'},{id:'n',label:'Name'},{id:'p',label:'Phone'}],v=>app.addTeach(v))">Add Teacher</button>`;
                    b.innerHTML+=`<div id="teach-list"></div>`; window.app.renderTeachers();
                } else if(t==='news'){
                    if(state.admin) b.innerHTML=`<button class="btn" style="width:100%;background:var(--primary);color:white;padding:10px;margin-bottom:15px" onclick="app.modal('Post News',[{id:'t',label:'Title'},{id:'b',label:'Details'}],v=>app.postNews(v))">Post News</button>`;
                    b.innerHTML+=`<div id="news-list"></div>`; window.app.renderNews();
                } else if(t==='ann'){
                    localStorage.setItem('la', state.anns.length); document.getElementById('badge-ann').classList.add('hidden');
                    if(state.admin) b.innerHTML=`<div style="background:#222;padding:15px;border-radius:12px;margin-bottom:15px"><textarea id="a-in" style="width:100%;background:transparent;border:none;color:white;outline:none;min-height:60px" placeholder="Write..."></textarea><div style="display:flex;justify-content:space-between;margin-top:10px"><label style="color:var(--accent)"><i class="fas fa-image"></i><input type="file" hidden onchange="app.handleFile(event)"></label><button class="btn" style="background:var(--primary);padding:5px 15px;color:white" onclick="app.postAnn()">Post</button></div></div>`;
                    b.innerHTML+=`<div id="ann-feed"></div>`; window.app.renderAnn();
                } else if(t==='timetable'){
                    b.innerHTML=`<div class="tt-wrapper"><div class="tt-grid" id="tt-grid"></div></div><br>${state.admin?'<button class="btn" style="width:100%;background:var(--primary);color:white;padding:10px" onclick="app.saveTT()">Save Changes</button>':''}`;
                    window.app.renderTimeTable();
                } else if(t==='email'){
                    b.innerHTML=`<div style="text-align:center;padding:40px;color:#666"><i class="fas fa-envelope" style="font-size:3rem;margin-bottom:10px"></i><br>Internal Mail<br><br><button class="btn" style="background:#222;color:white;padding:10px 20px" onclick="alert('Feature coming soon')">Compose</button></div>`;
                }
            },

            // --- CHAT & MEDIA ---
            renderChat: () => {
                const c=document.getElementById('chat-feed'); if(!c) return; c.innerHTML='';
                state.chats.forEach(m=>{
                    const mine = m.user===state.user;
                    const canDel = mine && (Date.now() - m.time < 300000); 
                    const isVip = state.vips.includes(m.user);
                    c.innerHTML+=`<div class="msg-row ${mine?'mine':''}"><div class="msg ${mine?'mine':'theirs'}"><b>${m.user}</b> ${isVip?'<span class="vip-tag">VIP</span>':''}<br>${m.img?`<img src="${m.img}" class="msg-img" onclick="app.viewMedia(this.src)">`:''}${m.text}<div style="text-align:right;font-size:0.6rem;opacity:0.7">${new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ${canDel?`<i class="fas fa-trash" onclick="app.delMsg('${m.id}')" style="margin-left:5px;cursor:pointer"></i>`:''}</div></div></div>`;
                });
                c.scrollTop=c.scrollHeight;
            },
            send: async () => { const v=document.getElementById('c-in').value; if(v||state.file){ await addDoc(collection(db,"chats"),{user:state.user,text:v,img:state.file,time:Date.now()}); document.getElementById('c-in').value=''; state.file=null; } },
            
            renderAnn: () => {
                const c=document.getElementById('ann-feed'); if(!c) return; c.innerHTML='';
                state.anns.forEach(a=>{
                    c.innerHTML+=`<div class="list-card" style="display:block"><div><span style="color:var(--accent)">ANNOUNCEMENT</span> <small style="float:right;color:#666">${new Date(a.time).toLocaleDateString()}</small></div><p style="margin-top:10px">${a.text}</p>${a.img?`<img src="${a.img}" style="width:100%;border-radius:10px;margin-top:10px" onclick="app.viewMedia(this.src)">`:''}${state.admin?`<div style="margin-top:10px;text-align:right"><i class="fas fa-trash del-icon" onclick="app.delItem('announcements','${a.id}')"></i></div>`:''}</div>`;
                });
            },
            postAnn: async () => { const v=document.getElementById('a-in').value; if(v||state.file){ await addDoc(collection(db,"announcements"),{text:v,img:state.file,time:Date.now()}); state.file=null; window.app.open('ann'); } },

            // --- TEACHERS & NEWS ---
            addTeach: async (v) => { await addDoc(collection(db,"teachers"),{sub:v[0],name:v[1],phone:v[2]}); },
            renderTeachers: () => {
                const c=document.getElementById('teach-list'); if(!c) return; c.innerHTML='';
                state.teachers.forEach(t=>{ c.innerHTML+=`<div class="list-card"><div><b>${t.sub}</b><br>${t.name}<br><small>${t.phone}</small></div>${state.admin?`<i class="fas fa-trash del-icon" onclick="app.delItem('teachers','${t.id}')"></i>`:`<a href="tel:${t.phone}" style="color:var(--success)"><i class="fas fa-phone"></i></a>`}</div>`; });
            },
            postNews: async (v) => { await addDoc(collection(db,"news"),{title:v[0],body:v[1],time:Date.now()}); },
            renderNews: () => {
                const c=document.getElementById('news-list'); if(!c) return; c.innerHTML='';
                state.news.forEach(n=>{ c.innerHTML+=`<div class="list-card" style="display:block"><b style="color:var(--warning)">LIVE UPDATE</b><h4 style="margin:5px 0">${n.title}</h4><p style="font-size:0.9rem;color:#aaa">${n.body}</p>${state.admin?`<br><i class="fas fa-trash del-icon" onclick="app.delItem('news','${n.id}')"></i>`:''}</div>`; });
            },

            // --- TIME TABLE PRO ---
            renderTimeTable: () => {
                const g=document.getElementById('tt-grid'); if(!g) return; g.innerHTML=`<div class="tt-cell tt-head">Time</div>`;
                ["Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>g.innerHTML+=`<div class="tt-cell tt-head">${d}</div>`);
                const times=["08:00","09:00","10:00","11:00","12:00"];
                times.forEach(t=>{
                    g.innerHTML+=`<div class="tt-cell tt-time">${t}</div>`;
                    ["Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{
                        const val = (state.tt[t] && state.tt[t][d]) || "";
                        g.innerHTML+=`<div class="tt-cell">${state.admin?`<input class="tt-input" value="${val}" onchange="app.updateTT('${t}','${d}',this.value)">`:val}</div>`;
                    });
                });
            },
            updateTT: (t,d,v) => { if(!state.tt[t]) state.tt[t]={}; state.tt[t][d]=v; },
            saveTT: async () => { await setDoc(doc(db,"settings","timetable"),{data:state.tt}); alert("Saved!"); },

            // --- ADMIN ATTENDANCE (Time Travel) ---
            openAttn: () => {
                const m=document.getElementById('feature-modal'); m.style.display='flex';
                document.getElementById('f-title').innerText="ATTENDANCE";
                document.getElementById('f-body').innerHTML=`
                    <div class="attn-date-bar">
                        <span style="font-size:0.9rem;color:#888">Select Date:</span>
                        <input type="date" id="attn-date" onchange="app.changeDate(this.value)" style="background:none;border:none;color:white;font-family:inherit">
                    </div>
                    <div id="attn-list"></div>`;
                document.getElementById('attn-date').value = state.selectedDate;
                window.app.renderAdminAttn();
            },
            changeDate: (v) => { state.selectedDate = v; window.app.renderAdminAttn(); },
            renderAdminAttn: () => {
                const c=document.getElementById('attn-list'); if(!c) return; c.innerHTML='';
                const d = state.selectedDate;
                const data = state.attn[d] || {};
                USERS.forEach(u=>{
                    const s=data[u];
                    c.innerHTML+=`
                    <div class="st-card">
                        <div style="font-weight:600">${u}</div>
                        <div class="st-acts">
                            <div class="act-btn ${s==='P'?'active-P':''}" onclick="app.mark('${d}','${u}','P')">P</div>
                            <div class="act-btn ${s==='A'?'active-A':''}" onclick="app.mark('${d}','${u}','A')">A</div>
                            <div class="act-btn ${s==='HD'?'active-HD':''}" onclick="app.mark('${d}','${u}','HD')">HD</div>
                            <div class="act-btn ${s==='H'?'active-H':''}" onclick="app.mark('${d}','${u}','H')">H</div>
                        </div>
                    </div>`;
                });
            },
            mark: async (d,u,s) => { 
                const n = state.attn[d] || {}; n[u]=s; 
                if(!state.attn[d]) state.attn[d] = {};
                state.attn[d][u] = s;
                window.app.renderAdminAttn(); // Instant Update
                await setDoc(doc(db,"attendance_log",d),n); 
            },

            // --- UTILS ---
            sendFile: (e) => { const f=e.target.files[0]; if(f && f.size<1000000){ const r=new FileReader(); r.onload=(ev)=>{state.file=ev.target.result; if(document.getElementById('chat-feed')) app.send();}; r.readAsDataURL(f); } else alert("File > 1MB"); },
            handleFile: (e) => { const f=e.target.files[0]; if(f && f.size<1000000){ const r=new FileReader(); r.onload=(ev)=>{state.file=ev.target.result; alert("Image Attached")}; r.readAsDataURL(f); } },
            viewMedia: (s) => { document.getElementById('media-viewer').style.display='flex'; document.getElementById('media-img').src=s; },
            delMsg: async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,"chats",id)); },
            delItem: async (col,id) => { if(confirm("Delete?")) await deleteDoc(doc(db,col,id)); },
            delExam: async () => { if(confirm("Remove Exam?")) await deleteDoc(doc(db,"settings","exam")); },
            
            // BAN & VIP
            openBan: () => {
                const m=document.getElementById('feature-modal'); m.style.display='flex';
                document.getElementById('f-title').innerText="USERS & VIP";
                const c=document.getElementById('f-body'); c.innerHTML='';
                USERS.forEach(u=>{
                    const b=state.banned.includes(u);
                    const v=state.vips.includes(u);
                    c.innerHTML+=`
                    <div class="list-card">
                        <b>${u} ${v?'<span style="color:gold;font-size:0.8rem">â˜… VIP</span>':''}</b>
                        <div style="display:flex;gap:5px">
                            <button style="padding:5px 8px;background:${v?'#ffd700':'#333'};color:${v?'#000':'#fff'};border:none;border-radius:5px" onclick="app.toggleVIP('${u}')">VIP</button>
                            <button style="padding:5px 8px;background:${b?'var(--success)':'var(--danger)'};color:white;border:none;border-radius:5px" onclick="app.toggleBan('${u}')">${b?'Unban':'Ban'}</button>
                        </div>
                    </div>`;
                });
            },
            toggleBan: async (u) => { let l=[...state.banned]; if(l.includes(u))l=l.filter(x=>x!==u); else l.push(u); await setDoc(doc(db,"settings","banned"),{list:l, vips:state.vips}); window.app.openBan(); },
            toggleVIP: async (u) => { let l=[...state.vips]; if(l.includes(u))l=l.filter(x=>x!==u); else l.push(u); await setDoc(doc(db,"settings","banned"),{list:state.banned, vips:l}); window.app.openBan(); },

            addEvent: async (t,d) => { if(t&&d) await addDoc(collection(db,"events"),{title:t,date:d}); },
            updateExam: async (n,d) => { if(n&&d) await setDoc(doc(db,"settings","exam"),{name:n,date:d}); },

            modal: (t,i,cb) => {
                document.getElementById('im-title').innerText=t; const c=document.getElementById('im-fields'); c.innerHTML='';
                i.forEach(x=>{c.innerHTML+=`<input id="mi-${x.id}" class="login-input" placeholder="${x.label}">`});
                document.getElementById('input-modal').style.display='flex';
                document.getElementById('im-save').onclick=()=>{ const v=i.map(x=>document.getElementById(`mi-${x.id}`).value); if(v.every(z=>z)){cb(v);document.getElementById('input-modal').style.display='none'} };
            }
        };

        setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),1000);
    </script>
</body>
</html>
